<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Management - Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <%- include('./partials/admin-styles') %>
    <style>
        .music-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .music-card { background: rgba(255, 255, 255, 0.9); border-radius: 1rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .music-card-header { padding: 1.5rem; border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
        .music-title { font-weight: 600; color: #1e293b; margin-bottom: 0.25rem; }
        .music-artist { font-size: 0.875rem; color: #64748b; }
        .music-card-body { padding: 1.5rem; }
        .music-meta { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .meta-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #64748b; }
        .music-card-footer { padding: 1rem 1.5rem; border-top: 1px solid rgba(0, 0, 0, 0.1); display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .empty-state { text-align: center; padding: 3rem; color: #64748b; }
        .audio-player-modal { display: none; position: fixed; bottom: 0; right: 0; width: 100%; max-width: 400px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 1rem 1rem 0 0; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3); z-index: 999; }
        .audio-player-modal.active { display: block; }
        .player-header { padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.2); display: flex; justify-content: space-between; align-items: center; }
        .player-body { padding: 1.5rem; }
        .player-controls { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; }
        .player-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .player-btn.play-btn { width: 55px; height: 55px; font-size: 1.5rem; }
        .progress-bar { width: 100%; height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; cursor: pointer; margin-bottom: 1rem; }
        .progress-fill { height: 100%; background: white; border-radius: 2px; width: 0%; }
        .time-display { display: flex; justify-content: space-between; font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem; }
        .volume-container { display: flex; align-items: center; gap: 0.5rem; }
        .volume-slider { flex: 1; height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="admin-container">
        <%- include('./partials/admin-sidebar') %>
        <div class="main-content">
            <div class="header">
                <h1><i class="fas fa-music"></i> Music Management</h1>
            </div>
            <div class="content-area">
                <div id="alertContainer"></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);"><i class="fas fa-music"></i></div><div><div class="stat-value" id="totalMusic">0</div><div class="stat-label">Total Music</div></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background: #10b981;"><i class="fas fa-check-circle"></i></div><div><div class="stat-value" id="approvedMusic">0</div><div class="stat-label">Approved</div></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background: #f59e0b;"><i class="fas fa-clock"></i></div><div><div class="stat-value" id="pendingMusic">0</div><div class="stat-label">Pending</div></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background: #3b82f6;"><i class="fas fa-play-circle"></i></div><div><div class="stat-value" id="activeMusic">0</div><div class="stat-label">Active</div></div></div>
                </div>
                <div class="filter-bar">
                    <div class="filter-group"><label>Status:</label><select id="filterApproved" onchange="loadMusic()"><option value="">All</option><option value="true">Approved</option><option value="false">Pending</option></select></div>
                    <div class="filter-group"><label>Genre:</label><select id="filterGenre" onchange="loadMusic()"><option value="">All</option><option value="pop">Pop</option><option value="rock">Rock</option><option value="jazz">Jazz</option><option value="classical">Classical</option><option value="electronic">Electronic</option><option value="other">Other</option></select></div>
                    <div class="filter-group"><label>Mood:</label><select id="filterMood" onchange="loadMusic()"><option value="">All</option><option value="happy">Happy</option><option value="sad">Sad</option><option value="energetic">Energetic</option><option value="calm">Calm</option><option value="romantic">Romantic</option><option value="other">Other</option></select></div>
                </div>
                <div id="musicContainer" class="music-grid"><div class="empty-state"><i class="fas fa-music"></i><p>Loading music...</p></div></div>
                <div class="pagination" id="paginationContainer"></div>
            </div>
        </div>
    </div>

    <div class="audio-player-modal" id="audioPlayerModal">
        <div class="player-header">
            <div><div class="player-title" id="playerTitle">Now Playing</div><div class="player-artist" id="playerArtist">Unknown Artist</div></div>
            <button class="close-player-btn" onclick="closeAudioPlayer()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
        </div>
        <div class="player-body">
            <audio id="audioElement" style="display: none;"></audio>
            <div class="player-controls">
                <button class="player-btn" onclick="rewindAudio()"><i class="fas fa-redo"></i></button>
                <button class="player-btn play-btn" id="playPauseBtn" onclick="togglePlayPause()"><i class="fas fa-play"></i></button>
                <button class="player-btn" onclick="forwardAudio()"><i class="fas fa-redo fa-flip-horizontal"></i></button>
            </div>
            <div class="progress-bar" id="progressBar" onclick="seekAudio(event)"><div class="progress-fill" id="progressFill"></div></div>
            <div class="time-display"><span id="currentTime">0:00</span><span id="duration">0:00</span></div>
            <div class="volume-container"><i class="fas fa-volume-down"></i><input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70" onchange="setVolume(this.value)"><i class="fas fa-volume-up"></i></div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentAudioId = null;
        let isPlaying = false;

        document.addEventListener('DOMContentLoaded', () => {
            loadMusic();
            loadStats();
        });

        async function loadMusic() {
            try {
                const isApproved = document.getElementById('filterApproved').value;
                const genre = document.getElementById('filterGenre').value;
                const mood = document.getElementById('filterMood').value;
                let url = `/admin/music?page=${currentPage}&limit=10`;
                if (isApproved) url += `&isApproved=${isApproved}`;
                if (genre) url += `&genre=${genre}`;
                if (mood) url += `&mood=${mood}`;
                const response = await fetch(url, { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    displayMusic(data.data);
                    totalPages = data.pagination.pages;
                    displayPagination();
                } else {
                    showAlert('Error loading music', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error loading music', 'error');
            }
        }

        function displayMusic(music) {
            const container = document.getElementById('musicContainer');
            if (music.length === 0) {
                container.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><i class="fas fa-music"></i><p>No music found</p></div>`;
                return;
            }
            container.innerHTML = music.map(m => `
                <div class="music-card">
                    <div class="music-card-header"><div class="music-title">${m.title}</div><div class="music-artist">${m.artist}</div></div>
                    <div class="music-card-body">
                        <div class="music-meta">
                            <div class="meta-item"><i class="fas fa-tag"></i> ${m.genre}</div>
                            <div class="meta-item"><i class="fas fa-heart"></i> ${m.mood}</div>
                            <div class="meta-item"><i class="fas fa-clock"></i> ${formatDuration(m.duration)}</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <span class="status-badge ${m.isApproved ? 'status-approved' : 'status-pending'}">${m.isApproved ? '✓ Approved' : '⏳ Pending'}</span>
                            <span class="status-badge ${m.isActive ? 'status-active' : 'status-rejected'}">${m.isActive ? '● Active' : '● Inactive'}</span>
                        </div>
                    </div>
                    <div class="music-card-footer">
                        <button class="btn btn-info btn-sm" onclick="playMusic('${m._id}', '${m.audioUrl}', '${m.title}')"><i class="fas fa-play"></i> Play</button>
                        <button class="btn btn-primary btn-sm" onclick="openEditModal('${m._id}')"><i class="fas fa-edit"></i> Edit</button>
                        ${!m.isApproved ? `<button class="btn btn-success btn-sm" onclick="approveMusic('${m._id}')"><i class="fas fa-check"></i> Approve</button>` : ''}
                        <button class="btn btn-danger btn-sm" onclick="deleteMusic('${m._id}')"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadStats() {
            try {
                const response = await fetch('/admin/music/stats', { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('totalMusic').textContent = data.data.total;
                    document.getElementById('approvedMusic').textContent = data.data.approved;
                    document.getElementById('pendingMusic').textContent = data.data.pending;
                    document.getElementById('activeMusic').textContent = data.data.active;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function displayPagination() {
            const container = document.getElementById('paginationContainer');
            let html = '';
            if (currentPage > 1) html += `<button onclick="goToPage(${currentPage - 1})"><i class="fas fa-chevron-left"></i> Previous</button>`;
            for (let i = 1; i <= totalPages; i++) html += `<button ${i === currentPage ? 'class="active"' : ''} onclick="goToPage(${i})">${i}</button>`;
            if (currentPage < totalPages) html += `<button onclick="goToPage(${currentPage + 1})">Next <i class="fas fa-chevron-right"></i></button>`;
            container.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadMusic();
            window.scrollTo(0, 0);
        }

        async function approveMusic(musicId) {
            if (!confirm('Approve this music?')) return;
            try {
                const response = await fetch(`/admin/music/${musicId}/approve`, { method: 'POST', credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    showAlert('Music approved successfully!', 'success');
                    loadMusic();
                    loadStats();
                } else {
                    showAlert(data.message || 'Error approving music', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error approving music', 'error');
            }
        }

        async function deleteMusic(musicId) {
            if (!confirm('Delete this music? This action cannot be undone.')) return;
            try {
                const response = await fetch(`/admin/music/${musicId}`, { method: 'DELETE', credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    showAlert('Music deleted successfully!', 'success');
                    loadMusic();
                    loadStats();
                } else {
                    showAlert(data.message || 'Error deleting music', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error deleting music', 'error');
            }
        }

        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i><span>${message}</span>`;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function playMusic(musicId, audioUrl, title) {
            const audio = document.getElementById('audioElement');
            const playerModal = document.getElementById('audioPlayerModal');
            const playPauseBtn = document.getElementById('playPauseBtn');
            if (currentAudioId === musicId && audio.src) {
                togglePlayPause();
                return;
            }
            currentAudioId = musicId;
            audio.src = audioUrl;
            document.getElementById('playerTitle').textContent = title;
            playerModal.classList.add('active');
            audio.play();
            isPlaying = true;
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('loadedmetadata', updateDuration);
            audio.addEventListener('ended', onAudioEnded);
        }

        function togglePlayPause() {
            const audio = document.getElementById('audioElement');
            const playPauseBtn = document.getElementById('playPauseBtn');
            if (isPlaying) {
                audio.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            } else {
                audio.play();
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;
            }
        }

        function updateProgress() {
            const audio = document.getElementById('audioElement');
            const progressFill = document.getElementById('progressFill');
            const currentTimeEl = document.getElementById('currentTime');
            if (audio.duration) {
                const percent = (audio.currentTime / audio.duration) * 100;
                progressFill.style.width = percent + '%';
                currentTimeEl.textContent = formatTime(audio.currentTime);
            }
        }

        function updateDuration() {
            const audio = document.getElementById('audioElement');
            const durationEl = document.getElementById('duration');
            durationEl.textContent = formatTime(audio.duration);
        }

        function seekAudio(event) {
            const audio = document.getElementById('audioElement');
            const progressBar = document.getElementById('progressBar');
            const rect = progressBar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audio.currentTime = percent * audio.duration;
        }

        function rewindAudio() {
            const audio = document.getElementById('audioElement');
            audio.currentTime = Math.max(0, audio.currentTime - 10);
        }

        function forwardAudio() {
            const audio = document.getElementById('audioElement');
            audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
        }

        function setVolume(value) {
            const audio = document.getElementById('audioElement');
            audio.volume = value / 100;
        }

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function onAudioEnded() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            isPlaying = false;
        }

        function closeAudioPlayer() {
            const audio = document.getElementById('audioElement');
            const playerModal = document.getElementById('audioPlayerModal');
            const playPauseBtn = document.getElementById('playPauseBtn');
            audio.pause();
            audio.currentTime = 0;
            playerModal.classList.remove('active');
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            isPlaying = false;
            currentAudioId = null;
        }

        function openEditModal(musicId) {
            alert('Edit functionality coming soon');
        }

        document.getElementById('audioElement').volume = 0.7;
    </script>
</body>
</html>
