<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShowOff Life - User Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .logo i {
            font-size: 2rem;
            color: #fbbf24;
        }

        .sidebar-menu {
            padding: 1rem 0;
            list-style: none;
        }

        .menu-item {
            margin: 0.25rem 1rem;
        }

        .menu-item a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            color: #64748b;
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }

        .menu-item a:hover,
        .menu-item a.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(4px);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #1e293b;
            font-size: 2rem;
            font-weight: 700;
        }

        .content-area {
            padding: 2rem;
        }

        /* Tables */
        .table-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .table-header h3 {
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: rgba(248, 250, 252, 0.8);
            padding: 1rem 2rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .data-table td {
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .data-table tr:hover {
            background: rgba(248, 250, 252, 0.5);
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active { background: #dcfce7; color: #166534; }
        .status-suspended { background: #fef3c7; color: #92400e; }
        .status-banned { background: #fecaca; color: #991b1b; }
        .status-verified { background: #dbeafe; color: #1e40af; }

        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info h4 {
            font-weight: 600;
            color: #1e293b;
        }

        .user-info p {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <%- include('./partials/admin-sidebar', { currentPage: 'users' }) %>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1>User Management</h1>
            </header>

            <div class="content-area">
                <!-- Page Header -->
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
    <div>
        <h2 style="font-size: 1.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">User Management</h2>
        <p style="color: #64748b;">Manage and moderate user accounts</p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <input type="text" id="user-search" placeholder="Search users..." style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; width: 250px;">
        <select id="status-filter" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="suspended">Suspended</option>
            <option value="banned">Banned</option>
        </select>
    </div>
</div>

<!-- Users Table -->
<div class="table-container">
    <div class="table-header">
        <h3>Users (<%= users.length %>)</h3>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>User</th>
                <th>Contact</th>
                <th>Status</th>
                <th>Verified</th>
                <th>Coins</th>
                <th>Joined</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <% if (users && users.length > 0) { %>
                <% users.forEach(user => { %>
                    <tr>
                        <td>
                            <div class="user-profile">
                                <img src="<%= user.profilePicture ? (user.profilePicture.startsWith('http') ? user.profilePicture : 'http://localhost:3000' + user.profilePicture) : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22%3E%3Crect width=%2240%22 height=%2240%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2216%22 fill=%22%23999%22%3E%3F%3C/text%3E%3C/svg%3E' %>" alt="<%= user.displayName %>" class="user-avatar" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22%3E%3Crect width=%2240%22 height=%2240%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2216%22 fill=%22%23999%22%3E%3F%3C/text%3E%3C/svg%3E'">
                                <div class="user-info">
                                    <h4><%= user.displayName %></h4>
                                    <p>@<%= user.username %></p>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>
                                <% if (user.email) { %>
                                    <div style="font-size: 0.875rem;"><%= user.email %></div>
                                <% } %>
                                <% if (user.phone) { %>
                                    <div style="font-size: 0.75rem; color: #64748b;"><%= user.phone %></div>
                                <% } %>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-<%= user.accountStatus || 'active' %>">
                                <%= (user.accountStatus || 'active').charAt(0).toUpperCase() + (user.accountStatus || 'active').slice(1) %>
                            </span>
                        </td>
                        <td>
                            <% if (user.isVerified) { %>
                                <span class="status-badge status-verified">
                                    <i class="fas fa-check-circle"></i> Verified
                                </span>
                            <% } else { %>
                                <span style="color: #64748b; font-size: 0.875rem;">Unverified</span>
                            <% } %>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #f59e0b;">
                                <i class="fas fa-coins"></i> <%= (user.coinBalance || 0).toLocaleString() %>
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b;">
                                Earned: <%= (user.totalCoinsEarned || 0).toLocaleString() %>
                            </div>
                        </td>
                        <td>
                            <div style="font-size: 0.875rem;"><%= new Date(user.createdAt).toLocaleDateString() %></div>
                            <div style="font-size: 0.75rem; color: #64748b;"><%= new Date(user.createdAt).toLocaleTimeString() %></div>
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                <button class="btn btn-sm btn-primary" onclick="viewUser('<%= user._id %>')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm" style="background: #8b5cf6; color: white;" onclick="viewEarnings('<%= user._id %>', '<%= user.displayName %>')" title="View Earnings">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                                <% if (!user.isVerified) { %>
                                    <button class="btn btn-sm btn-success" onclick="verifyUser('<%= user._id %>', '<%= user.displayName %>')" title="Verify User">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                <% } else { %>
                                    <button class="btn btn-sm btn-warning" onclick="unverifyUser('<%= user._id %>', '<%= user.displayName %>')" title="Remove Verification">
                                        <i class="fas fa-times-circle"></i>
                                    </button>
                                <% } %>
                                <button class="btn btn-sm" style="background: #f59e0b; color: white;" onclick="manageCoins('<%= user._id %>', '<%= user.displayName %>')" title="Manage Coins">
                                    <i class="fas fa-coins"></i>
                                </button>
                                <% if (user.accountStatus !== 'suspended') { %>
                                    <button class="btn btn-sm btn-warning" onclick="suspendUser('<%= user._id %>', '<%= user.displayName %>')" title="Suspend User">
                                        <i class="fas fa-pause"></i>
                                    </button>
                                <% } else { %>
                                    <button class="btn btn-sm btn-success" onclick="activateUser('<%= user._id %>', '<%= user.displayName %>')" title="Activate User">
                                        <i class="fas fa-play"></i>
                                    </button>
                                <% } %>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('<%= user._id %>', '<%= user.displayName %>')" title="Delete User">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr>
                    <td colspan="7" class="loading">
                        <i class="fas fa-users"></i>
                        <p>No users found</p>
                    </td>
                </tr>
            <% } %>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<% if (pagination && pagination.pages > 1) { %>
    <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem;">
        <% for (let i = 1; i <= pagination.pages; i++) { %>
            <a href="/admin/users?page=<%= i %>" class="btn <%= i === pagination.page ? 'btn-primary' : '' %>" style="<%= i === pagination.page ? '' : 'background: white; color: #64748b; border: 1px solid #e2e8f0;' %>">
                <%= i %>
            </a>
        <% } %>
    </div>
<% } %>

<!-- User Details Modal -->
<div id="userModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between;">
            <h3 style="font-size: 1.25rem; font-weight: 600;">User Details</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div id="userModalContent" style="padding: 1.5rem;">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>
</div>

<!-- Earnings Modal -->
<div id="earningsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: white; border-radius: 1rem; max-width: 900px; width: 95%; margin: 2rem auto; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: white; z-index: 10;">
            <h3 style="font-size: 1.25rem; font-weight: 600;">User Earnings Breakdown</h3>
            <button onclick="closeEarningsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div id="earningsModalContent" style="padding: 1.5rem;">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>
</div>

<script>
    function viewEarnings(userId, userName) {
        document.getElementById('earningsModalContent').innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #667eea;"></i>
                <p style="margin-top: 1rem; color: #64748b;">Loading earnings details...</p>
            </div>
        `;
        document.getElementById('earningsModal').style.display = 'flex';
        
        fetch(`/api/admin/users/${userId}/earnings`, {
            method: 'GET',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const earnings = data.data.earnings;
                const stats = data.data.stats;
                const user = data.data.user;
                const recentTransactions = data.data.recentTransactions || [];
                const withdrawalHistory = data.data.withdrawalHistory || [];
                
                const profilePic = user.profilePicture 
                    ? (user.profilePicture.startsWith('http') ? user.profilePicture : 'http://localhost:3000' + user.profilePicture)
                    : "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect width='80' height='80' fill='%23ddd'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='40' fill='%23999'%3E%3F%3C/text%3E%3C/svg%3E";
                
                let earningsHTML = `
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <img src="${profilePic}" alt="${user.displayName}" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 1rem; object-fit: cover;">
                        <h3 style="margin-bottom: 0.5rem; font-size: 1.5rem;">${user.displayName}</h3>
                        <p style="color: #64748b;">@${user.username}</p>
                    </div>
                    
                    <!-- Key Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; border-radius: 0.75rem;">
                            <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Earnings</p>
                            <p style="font-size: 1.75rem; font-weight: 700;"><i class="fas fa-coins"></i> ${stats.totalEarnings.toLocaleString()}</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 0.75rem;">
                            <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Current Balance</p>
                            <p style="font-size: 1.75rem; font-weight: 700;"><i class="fas fa-wallet"></i> ${stats.currentBalance.toLocaleString()}</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 0.75rem;">
                            <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Withdrawable</p>
                            <p style="font-size: 1.75rem; font-weight: 700;"><i class="fas fa-arrow-down"></i> ${stats.withdrawableBalance.toLocaleString()}</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 1.5rem; border-radius: 0.75rem;">
                            <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Avg Daily</p>
                            <p style="font-size: 1.75rem; font-weight: 700;"><i class="fas fa-chart-line"></i> ${Math.round(stats.averageDailyEarnings).toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <!-- Earnings Breakdown -->
                    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: #1e293b;">Earnings by Source</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #667eea;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Video Uploads</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #667eea;">${earnings.videoUploadEarnings.toLocaleString()}</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #10b981;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Content Sharing</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${earnings.contentSharingEarnings.toLocaleString()}</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #f59e0b;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Spin Wheel</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${earnings.wheelSpinEarnings.toLocaleString()}</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #ef4444;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Rewarded Ads</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">${earnings.rewardedAdEarnings.toLocaleString()}</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #8b5cf6;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Referrals</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">${earnings.referralEarnings.toLocaleString()}</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #06b6d4;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Competitions</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #06b6d4;">${earnings.competitionEarnings.toLocaleString()}</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #ec4899;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Gifts Received</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #ec4899;">${earnings.giftEarnings.toLocaleString()}</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #64748b;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Other</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #64748b;">${earnings.otherEarnings.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Withdrawal Statistics -->
                    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: #1e293b;">Withdrawal Statistics</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Total Withdrawn</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">${stats.totalWithdrawn.toLocaleString()}</p>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                                <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Withdrawal Count</p>
                                <p style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">${stats.withdrawalCount}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Transactions -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: #1e293b;">Recent Transactions (Last 20)</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                    <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #64748b;">Type</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #64748b;">Amount</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #64748b;">Balance After</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #64748b;">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recentTransactions.map(tx => `
                                        <tr style="border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 0.75rem;">
                                                <span style="background: #f0f4ff; color: #667eea; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">
                                                    ${tx.type.replace(/_/g, ' ').toUpperCase()}
                                                </span>
                                            </td>
                                            <td style="padding: 0.75rem; font-weight: 600; color: ${tx.amount > 0 ? '#10b981' : '#ef4444'};">
                                                ${tx.amount > 0 ? '+' : ''}${tx.amount.toLocaleString()}
                                            </td>
                                            <td style="padding: 0.75rem; color: #64748b;">${tx.balanceAfter.toLocaleString()}</td>
                                            <td style="padding: 0.75rem; color: #64748b;">${new Date(tx.createdAt).toLocaleDateString()} ${new Date(tx.createdAt).toLocaleTimeString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Withdrawal History -->
                    ${withdrawalHistory.length > 0 ? `
                        <div>
                            <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: #1e293b;">Withdrawal History</h4>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #64748b;">Amount</th>
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #64748b;">Method</th>
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #64748b;">Status</th>
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #64748b;">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${withdrawalHistory.map(w => `
                                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                                <td style="padding: 0.75rem; font-weight: 600;">${w.coinAmount.toLocaleString()} coins</td>
                                                <td style="padding: 0.75rem; color: #64748b;">${w.method.replace(/_/g, ' ').toUpperCase()}</td>
                                                <td style="padding: 0.75rem;">
                                                    <span style="background: ${w.status === 'completed' ? '#dcfce7' : w.status === 'pending' ? '#fef3c7' : '#fecaca'}; color: ${w.status === 'completed' ? '#166534' : w.status === 'pending' ? '#92400e' : '#991b1b'}; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">
                                                        ${w.status.toUpperCase()}
                                                    </span>
                                                </td>
                                                <td style="padding: 0.75rem; color: #64748b;">${new Date(w.createdAt).toLocaleDateString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('earningsModalContent').innerHTML = earningsHTML;
            } else {
                document.getElementById('earningsModalContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
                        <p style="color: #64748b;">Error loading earnings: ${data.message}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('earningsModalContent').innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
                    <p style="color: #64748b;">Error loading earnings: ${error.message}</p>
                </div>
            `;
        });
    }

    function closeEarningsModal() {
        document.getElementById('earningsModal').style.display = 'none';
    }

    function viewUser(userId) {
        document.getElementById('userModalContent').innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #667eea;"></i>
                <p style="margin-top: 1rem; color: #64748b;">Loading user details...</p>
            </div>
        `;
        document.getElementById('userModal').style.display = 'flex';
        
        // Fetch real user data from API
        fetch(`/api/admin/users/${userId}`, {
            method: 'GET',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.data.user;
                const stats = data.data.stats;
                const profilePic = user.profilePicture 
                    ? (user.profilePicture.startsWith('http') ? user.profilePicture : 'http://localhost:3000' + user.profilePicture)
                    : "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23ddd'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='40' fill='%23999'%3E%3F%3C/text%3E%3C/svg%3E";
                
                document.getElementById('userModalContent').innerHTML = `
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <img src="${profilePic}" alt="${user.displayName}" style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 1rem; object-fit: cover;">
                        <h3 style="margin-bottom: 0.5rem;">${user.displayName}</h3>
                        <p style="color: #64748b; margin-bottom: 0.5rem;">@${user.username}</p>
                        ${user.isVerified ? '<span class="status-badge status-verified"><i class="fas fa-check-circle"></i> Verified</span>' : ''}
                    </div>
                    
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">Contact Information</h4>
                        ${user.email ? `<p style="font-size: 0.875rem; margin-bottom: 0.25rem;"><i class="fas fa-envelope"></i> ${user.email}</p>` : ''}
                        ${user.phone ? `<p style="font-size: 0.875rem;"><i class="fas fa-phone"></i> ${user.phone}</p>` : ''}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: #64748b; font-size: 0.75rem;">Account Status</strong>
                            <p style="font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem;">${(user.accountStatus || 'active').charAt(0).toUpperCase() + (user.accountStatus || 'active').slice(1)}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: #64748b; font-size: 0.75rem;">Total Posts</strong>
                            <p style="font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem;">${stats.totalPosts || 0}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: #64748b; font-size: 0.75rem;">Followers</strong>
                            <p style="font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem;">${user.followersCount || 0}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: #64748b; font-size: 0.75rem;">Following</strong>
                            <p style="font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem;">${user.followingCount || 0}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: #92400e; font-size: 0.75rem;">Coin Balance</strong>
                            <p style="font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem; color: #f59e0b;"><i class="fas fa-coins"></i> ${(user.coinBalance || 0).toLocaleString()}</p>
                        </div>
                        <div style="background: #dcfce7; padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: #166534; font-size: 0.75rem;">Total Earned</strong>
                            <p style="font-size: 1.25rem; font-weight: 600; margin-top: 0.25rem; color: #10b981;"><i class="fas fa-coins"></i> ${(user.totalCoinsEarned || 0).toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <p style="font-size: 0.75rem; color: #64748b;">
                            <strong>Joined:</strong> ${new Date(user.createdAt).toLocaleDateString()} at ${new Date(user.createdAt).toLocaleTimeString()}
                        </p>
                        ${user.lastLogin ? `<p style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                            <strong>Last Login:</strong> ${new Date(user.lastLogin).toLocaleDateString()} at ${new Date(user.lastLogin).toLocaleTimeString()}
                        </p>` : ''}
                    </div>
                `;
            } else {
                document.getElementById('userModalContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
                        <p style="color: #64748b;">Error loading user details: ${data.message}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('userModalContent').innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
                    <p style="color: #64748b;">Error loading user details: ${error.message}</p>
                </div>
            `;
        });
    }

    function suspendUser(userId, userName) {
        if (confirmAction(`Are you sure you want to suspend ${userName}?`)) {
            fetch(`/api/admin/users/${userId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    status: 'suspended',
                    reason: 'Suspended by admin'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User suspended successfully');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    }

    function activateUser(userId, userName) {
        if (confirmAction(`Are you sure you want to activate ${userName}?`)) {
            fetch(`/api/admin/users/${userId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    status: 'active',
                    reason: 'Activated by admin'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User activated successfully');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    }

    function verifyUser(userId, userName) {
        if (confirmAction(`Are you sure you want to verify ${userName}?`)) {
            fetch(`/api/admin/users/${userId}/verify`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    isVerified: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User verified successfully');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    }

    function unverifyUser(userId, userName) {
        if (confirmAction(`Are you sure you want to remove verification from ${userName}?`)) {
            fetch(`/api/admin/users/${userId}/verify`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    isVerified: false
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User verification removed successfully');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    }

    function manageCoins(userId, userName) {
        const action = prompt(`Manage coins for ${userName}:\nEnter 'add' or 'subtract':`);
        if (!action || (action !== 'add' && action !== 'subtract')) return;
        
        const amount = parseInt(prompt(`Enter amount to ${action}:`));
        if (!amount || amount <= 0) return;
        
        const reason = prompt('Enter reason (optional):') || `Admin ${action} coins`;
        
        if (confirmAction(`${action === 'add' ? 'Add' : 'Subtract'} ${amount} coins ${action === 'add' ? 'to' : 'from'} ${userName}?`)) {
            fetch(`/api/admin/users/${userId}/coins`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    amount: amount,
                    type: action,
                    reason: reason
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Coins ${action === 'add' ? 'added' : 'removed'} successfully`);
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    }

    function deleteUser(userId, userName) {
        if (confirmAction(`⚠️ WARNING: This will permanently delete ${userName} and ALL their content. This action cannot be undone!\n\nAre you absolutely sure?`)) {
            const confirmation = prompt(`Type "DELETE" to confirm deletion of ${userName}:`);
            if (confirmation === 'DELETE') {
                fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('User deleted successfully');
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
            }
        }
    }

    function closeModal() {
        document.getElementById('userModal').style.display = 'none';
    }

    function confirmAction(message) {
        return confirm(message);
    }

    // Search and filter functionality
    document.getElementById('user-search').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    document.getElementById('status-filter').addEventListener('change', function() {
        const filterValue = this.value;
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            if (!filterValue) {
                row.style.display = '';
            } else {
                const statusBadge = row.querySelector('.status-badge');
                if (statusBadge && statusBadge.textContent.toLowerCase().includes(filterValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    });
</script>
            </div>
        </main>
    </div>
</body>
</html>